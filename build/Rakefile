require 'rake'
require 'rbconfig'

desc "management processes for the kube cluster and terraform commands"
namespace :cluster do
  desc "Scaffold new cluster environment configuration from template"
  task :scaffold, [:chainnet, :provider] do |t, args|
    check_args(args)

    # create path location
    system('mkdir -p ../.live')
    system("mkdir #{path(args)}") or exit

    # create config from template
    system("go run github.com/belitre/gotpl ./terraform/template/aws/cluster.tf.tpl \
      --set chainnet=#{args[:chainnet]} \
      > #{path(args)}/main.tf
    ")

    system("go run github.com/belitre/gotpl ./terraform/template/aws/.envrc.tpl \
      --set chainnet=#{args[:chainnet]} \
      > #{path(args)}/.envrc
    ")


    # init terraform
    system("cd #{path(args)} && terraform init")

    puts "Cluster configuration scaffolding complete: #{path(args)}"
    puts "Now run `rake cluster:create[#{args[:chainnet]},#{args[:provider]}]` to deploy your cluster"
  end

  desc "Create cluster"
  task :create, [:chainnet, :provider] do |t, args|
    check_args(args)
    puts "Deploy cluster config: #{path(args)}"
    system("cd #{path(args)} && terraform apply") or exit 1
    puts "Cluster #{path(args)} created successfully"
    puts "Now run `rake sifnode:install[#{args[:chainnet]},#{args[:provider]}]` to deploy sifnode to your cluster"
  end

  task :destroy, [:chainnet, :provider] do |t, args|
    check_args(args)
    puts "Destroy running cluster: #{path(args)}"
    system("cd #{path(args)} && terraform destroy") or exit 1
    puts "Cluster #{path(args)} destroyed successfully"
  end
end

desc "Manage sifnode install, upgrade, etc processes"
namespace :sifnode do
  desc "Install sifnode on cluster"
  task :install, [:chainnet, :provider, :namespace, :image,:image_tag] do |t, args|
    check_args(args)

    cmd = %Q{helm upgrade #{ns(args)} ../build/helm/sifnode \
        --set sifnode.env.chainnet=#{args[:chainnet]} --install -n #{ns(args)} --create-namespace \
        --set image.tag=#{image_tag(args)} \
        --set image.repository=#{image_repository(args)}
    }

    system({"KUBECONFIG" => kubeconfig(args) }, cmd)
  end

  task :uninstall, [:chainnet, :provider, :namespace] do |t, args|
    check_args(args)
    cmd = "helm delete #{ns(args)} -n #{ns(args)}"
    system({"KUBECONFIG" => kubeconfig(args) }, cmd)
  end
end

desc "Install require dependencies"
namespace :dependencies do
  desc "Install terraform and Helm for OSX"
  task :install do
    case detect_os
    when :macosx
      puts "Installing Terraform"
      system("brew install terraform")

      puts "Installing aws-iam-authenticator"
      system("brew install aws-iam-authenticator")

      puts "Installing kubectl"
      system("brew install kubernetes-cli")

      puts "Installing Helm 3"
      system("brew install helm")
    when :linux
      # TODO complete....
      puts "Installing aws-iam-authenticator"
      system("curl -o aws-iam-authenticator https://amazon-eks.s3.us-west-2.amazonaws.com/1.18.8/2020-09-18/bin/linux/amd64/aws-iam-authenticator")

      puts "Installig helm"
      system("curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash")
    else
      puts "Sorry not currently supported!"
    end
  end
end

# path returns the path of the terraform config that is generated as part of the scaffold task
def path(args)
  "../.live/sifchain-#{args[:provider]}-#{args[:chainnet]}"
end

# check_args checks to make sure the required args are passed in
def check_args(args)
  if args[:chainnet] == nil
    puts "Please provider a chainnet argument E.g testnet, mainnet, etc"
    exit
  end

  case args[:provider]
  when "aws"
  when "az"
    puts "Build me!"
    exit
  when "gcp"
    puts "Build me!"
    exit
  when "do"
    puts "Build me!"
    exit
  else
    puts "Please provide a cloud host provider. E.g aws"
    exit
  end
end

# kubeconfig returns the path to the kubeconfig file based on the args
def kubeconfig(args)
  "#{path(args)}/kubeconfig_sifchain-#{args[:provider]}-#{args[:chainnet]}"
end

# ns = namespace for kubes returns the arg with the namespace if set or the default setting
def ns(args)
  args[:namespace] ? "#{args[:namespace]}" : "sifnode"
end

# image_tag returns the arg for image_tag if set or the default tag setting
def image_tag(args)
    args[:image_tag] ? "#{args[:image_tag]}" : "testnet"
end

# image_repository returns the arg with a image_repository if set or the default setting
def image_repository(args)
  args[:image_repository] ? "#{args[:image_repository]}" : "sifchain/sifnoded"
end

def detect_os
  @os ||= (
  host_os = RbConfig::CONFIG['host_os']
  case host_os
  when /mswin|msys|mingw|cygwin|bccwin|wince|emc/
    :windows
  when /darwin|mac os/
    :macosx
  when /linux/
    :linux
  when /solaris|bsd/
    :unix
  else
    raise Error::WebDriverError, "unknown os: #{host_os.inspect}"
  end
  )
end
