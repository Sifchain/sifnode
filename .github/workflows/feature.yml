name: Build and deploy feature

on:
  push:
    branches:
      - 'feature/*'

jobs:
  build:
    name: build
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v2

      - name: Login to Github container registry
        run: docker login -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }} ghcr.io

      - name: Build and tag image
        run: |
          make CHAINNET=sifnode/sifnoded:${{ github.sha }} BINARY=sifnoded build-image
          docker tag sifnode/sifnoded:${{ github.sha }} ghcr.io/sifchain/sifnode/sifnoded:${{ github.sha }}

      - name: Push image
        run: |
          docker push ghcr.io/sifchain/sifnode/sifnoded:${{ github.sha }}

#  deploy:
#    runs-on: ubuntu-latest
#    env:
#      WORKING_DIRECTORY: ./build
#      WORKSPACE_PREFIX: sifchain-aws
#      WORKSPACE_NAME: feature-testnets
#    needs: build
#    steps:
#      - name: Check out the repo
#        uses: actions/checkout@v2
#
#      - name: Setup ruby
#        uses: actions/setup-ruby@v1
#
#      - name: Install AWS CLI
#        uses: chrislennon/action-aws-cli@v1.1
#
#      - name: Set AWS credentials
#        uses: aws-actions/configure-aws-credentials@v1
#        with:
#          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#          aws-region: us-west-2
#
#      - name: Create k8s config
#        working-directory: ${{env.WORKING_DIRECTORY}}
#        run: |
#          mkdir -p ../.live/${{ env.WORKSPACE_PREFIX}}-${{ env.WORKSPACE_NAME }}
#          aws eks --region us-west-2 update-kubeconfig \
#                  --name ${{ env.WORKSPACE_PREFIX}}-${{ env.WORKSPACE_NAME }} \
#                  --kubeconfig ../.live/${{ env.WORKSPACE_PREFIX}}-${{ env.WORKSPACE_NAME }}/kubeconfig_${{ env.WORKSPACE_PREFIX}}-${{ env.WORKSPACE_NAME }}
#
#      - name: Deploy node to cluster
#        working-directory: ${{ env.WORKING_DIRECTORY }}
#        run: |
#          rake 'cluster:sifnode:deploy[${{ env.WORKSPACE_NAME }},aws,${{ github.actor }},sifchain/sifnoded,${{ github.sha }}]'
#
#      - name: Cluster status
#        working-directory: ${{ env.WORKING_DIRECTORY }}
#        run: |
#          rake 'cluster:status[testnet-${{ github.actor }},aws]'
